---
title: "Pure Mediation"
author: "Uriah Finkel"
format: revealjs
---

## Causal Assumption

```{r}
#| echo: false

library(reactable)
library(dplyr)
```


Pure mediation means that the effect of treatment A on outcome Y is transmitted only through the mediator M.

Smoking üö¨ might cause COPD ü´Å only by increasing TAR ‚ö´ levels in the lungs.

## Why Is Mediation Challenging? {.smaller}

::::: columns
::: {.column width="30%"}
![](causal_conventional.png)
:::

::: {.column width="70%"}
-   Most conventional causal questions explore two possible worlds, with a treatment assigned to A=0 or A=1.
:::
:::::

## Why Is Mediation Challenging? {.smaller}

::::: columns
::: {.column width="30%"}
![](causal_mediation.png)
:::

::: {.column width="70%"}
-   Most conventional causal questions explore two possible worlds, with a treatment assigned to A=0 or A=1.

-   Mediation involves each combination of the original treatment (A=0, A=1) with the mediator levels (M=0, M=1).
:::
:::::

## Why Is Mediation Challenging? {.smaller}

::::: columns
::: {.column width="30%"}
![](controlled_direct_effect.png)
:::

::: {.column width="70%"}
-   Most conventional causal questions explore two possible worlds, with a treatment assigned to A=0 or A=1.

-   Mediation involves each combination of the original treatment (A=0, A=1) with the mediator levels (M=0, M=1).

-   Controlling both the treatment and the mediator may feel unnatural:

$CDE(m) = Y | [do(A=1),do(m)] - Y|[do(A=0),do(m)]$
:::
:::::

## Why Is Mediation Challenging? {.smaller}

::::: columns
::: {.column width="30%"}
![](do_m.png)
:::

::: {.column width="70%"}
-   Most conventional causal questions explore two possible worlds, with a treatment assigned to A=0 or A=1.

-   Mediation involves each combination of the original treatment (A=0, A=1) with the mediator levels (M=0, M=1).

-   Controlling both the treatment and the mediator may feel unnatural:

$CDE(m) = Y | [do(A=1),do(m)] - Y|[do(A=0),do(m)]$

-   If that is not strange enough, most mediator interventions are not well defined. If smoking (A) leads to TAR (M) which leads to COPD (Y), how can we manipulate TAR independently? One might imagine small creatures cleaning TAR from the lungs (M=0) or adding TAR (M=1).
:::
:::::

## Why Is Mediation Helpful? {.smaller}

::::: columns
::: {.column width="30%"}
![](benefit_mediation.png)
:::

::: {.column width="70%"}
$CDE(m) = Y | [do(A=1),do(m)] - Y|[do(A=0),do(m)]$

Mediation moves us closer to "how nature works" by making causal paths explicit, our narrative becomes more aligned with domain expertise. "Smoking causes COPD" is less informative than "Smoking causes COPD by increasing TAR in the lungs".

Pure mediation sets clear boundaries on which causal paths are allowed.
:::
:::::

## CDE under Pure Mediation {.smaller}

::::: columns
::: {.column width="30%"}
![](controlled_direct_effect.png)
:::

::: {.column width="70%"}
$CDE(m) = Y | [do(A=1),do(m)] - Y|[do(A=0),do(m)]$

Assuming pure mediation:

$CDE(m) = Y |do(m) - Y|do(m) = 0$

- Under pure mediation, a controlled direct effect of zero means that all harm from cigarettes is blocked once we fix TAR.
:::
:::::

## CDE under Pure Mediation {.smaller}

::::: columns
::: {.column width="30%"}
![](cde_0.png)
:::

::: {.column width="70%"}
$CDE(m) = Y | [do(A=1),do(m)] - Y|[do(A=0),do(m)]$

Assuming Pure Mediation:

$CDE(M=0) = Y |do(M=0) - Y|do(M=0) = 0$

- Under pure mediation, a controlled direct effect of zero means that all harm from cigarettes is blocked once we fix TAR.

-   If a small creature cleaned all the TAR from the lungs, smoking would not cause COPD.
:::
:::::

## CDE under Pure Mediation {.smaller}

::::: columns
::: {.column width="30%"}
![](cde_1.png)
:::

::: {.column width="70%"}
$CDE(m) = Y | [do(A=1),do(m)] - Y|[do(A=0),do(m)]$

Assuming Pure Mediation:

$CDE(M=1) = Y |do(M=1) - Y|do(M=1) = 0$

- Under pure mediation, a controlled direct effect of zero means that all harm from cigarettes is blocked once we fix TAR.

-   If a small creature cleaned all the TAR from the lungs, smoking would not cause COPD.

-   If a small creature added TAR to the lungs, avoiding smoking would not prevent COPD.
:::
:::::

## NDE under Pure Mediation {.smaller}

::::: columns
::: {.column width="30%"}
![](nde.png)
:::

::: {.column width="70%"}
$NDE = Y|[do(A=1),do(M|do(A=0))] - Y|[do(A=0),do(M|do(A=0))]$

-   Under pure mediation, the NDE blocks all the harm caused by cigarettes by setting the mediator to the value it would take under no smoking, while comparing smoking versus non-smoking with this manipulated M.
:::
:::::

## NDE under Pure Mediation {.smaller}

::::: columns
::: {.column width="30%"}
![](nde.png)
:::

::: {.column width="70%"}
$NDE = Y|[do(M|do(A=0))] - Y|[do(M|do(A=0))] = 0$

-   Under pure mediation, the NDE blocks all the harm caused by cigarettes by setting the mediator to the value it would take under no smoking, while comparing smoking versus non-smoking with this manipulated M.

-   Under pure mediation, once we know the value of the mediator M, the original treatment A no longer matters. The natural direct effect may feel abstract, but once TAR (M) is fixed, it does not matter whether the patient actually smoked.
:::
:::::

## NIE under Pure Mediation {.smaller}

::::: columns
::: {.column width="30%"}
![](nde.png)

![](nie.png)
:::

::: {.column width="70%"}
$NIE = Y|[do(A=0),do(M|do(A=1))] - Y|[do(A=0),do(M|do(A=0))]$

-   Under pure mediation, the NIE captures all the harm caused by cigarettes by manipulating TAR (the mediator) to the values it would take under smoking versus not smoking.
:::
:::::

## NIE under Pure Mediation {.smaller}

::::: columns
::: {.column width="30%"}
![](nde.png)

![](nie.png)
:::

::: {.column width="70%"}
$NIE = Y|[do(M|do(A=1))] - Y|[do(M|do(A=0))]$

-   Under pure mediation, the NIE captures all the harm caused by cigarettes by manipulating TAR (the mediator) to the values it would take under smoking versus not smoking.

-   Again, the original treatment assignment A becomes irrelevant.
:::
:::::

## {.smaller}

::::: columns
::: {.column width="45%"}

```{r}
countefactual_data <- tibble::tribble(
   ~"X", ~"A", ~"Y_a0", ~"Y_a1", ~"M_a0", ~"M_a1", ~"Y_m0", ~"Y_m1",
   "0", "1", "0", "1", "0", "1", "0", "1",
   "0", "1", "0", "0", "0", "0", "0", "0",
   "0", "0", "1", "1", "1", "1", "1", "1",
   "0", "0", "0", "1", "0", "1", "0", "1",
   "0", "0", "0", "0", "0", "0", "0", "0",
   "0", "0", "0", "0", "0", "0", "0", "0", 
   "1", "1", "1", "1", "1", "1", "0", "1", 
   "1", "1", "1", "1", "1", "1", "0", "1",
   "1", "1", "1", "1", "1", "1", "0", "1",
   "1", "1", "1", "1", "0", "0", "1", "1",
   "1", "1", "1", "1", "1", "1", "1", "1",
   "1", "1", "0", "1", "0", "1", "0", "1",
   "1", "1", "0", "0", "0", "0", "0", "1",
   "1", "1", "0", "0", "0", "0", "0", "0",
   "1", "0", "1", "1", "1", "1", "0", "1",
   "1", "0", "0", "1", "0", "1", "0", "1"
  ) |> 
  mutate(
    observed_y = case_when(
      A == "0" ~ Y_a0,
      A == "1" ~ Y_a1
    ),
    ITE = as.numeric(Y_a1) - as.numeric(Y_a0)
  ) |> 
  arrange(
    A, observed_y, X
  ) |> 
  select(X, A, M_a0, M_a1, Y_m0, Y_m1, Y_a0, Y_a1, ITE) |> 
  mutate(
    observed_m = case_when(
      A == "0" ~ M_a0,
      A == "1" ~ M_a1
    ),
    observed_y = case_when(
      A == "0" ~ Y_a0,
      A == "1" ~ Y_a1
    )
  ) |> 
  arrange(
    A, observed_y, X
  )

countefactual_data_reactable_raw <- countefactual_data |> 
  reactable(
    theme = reactableTheme(
      backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )),
  sortable = FALSE,
  defaultPageSize = 19,
  columns = list(
    observed_y = colDef(
      show = FALSE
    ),
    observed_m = colDef(
      show = FALSE
    ),
    ITE = colDef(
      style = function(value) {
      if(value == "1")
      list(background = "pink")
    }
    ),
    Y_a0 = colDef(
      name = "Y<sup>A0",
      html = TRUE,
      style = function(value) {
      if(value == "1")
      list(background = "pink")
    }
    ),
    M_a1 = colDef(
      name = "M<sup>A1",
      html = TRUE,
      style = function(value) {
      if(value == "1")
      list(background = "lightgray")
    }
    ),
    M_a0 = colDef(
      name = "M<sup>A0",
      html = TRUE,
  style = function(value) {
    if (value == "1") {
      list(background = "lightgray")
    }
  }
    ),
    Y_a1 = colDef(
      name = "Y<sup>A1",
      html = TRUE,
      style = function(value) {
      if(value == "1")
      list(background = "pink")
    }
    ),
    Y_m0 = colDef(
      name = "Y<sup>M0",
      html = TRUE,
      style = function(value) {
      if(value == "1")
      list(background = "#E6D7FF")
    }
    ),
    Y_m1 = colDef(
      name = "Y<sup>M1",
      html = TRUE,
      style = function(value) {
      if(value == "1")
      list(background = "#E6D7FF")
    }
    )
  ),
  defaultColDef = colDef(maxWidth = 50),
  style = list(fontSize = "1rem"))


countefactual_data_reactable_raw

```

:::

::: {.column width="55%"}

#### üòá God-Given Counterfactual Data

We can now explore how the components of the Natural Indirect Effect:

:::


:::::

## {.smaller}

::::: columns
::: {.column width="45%"}

```{r}
countefactual_data <- tibble::tribble(
   ~"X", ~"A", ~"Y_a0", ~"Y_a1", ~"M_a0", ~"M_a1", ~"Y_m0", ~"Y_m1",
   "0", "1", "0", "1", "0", "1", "0", "1",
   "0", "1", "0", "0", "0", "0", "0", "0",
   "0", "0", "1", "1", "1", "1", "1", "1",
   "0", "0", "0", "1", "0", "1", "0", "1",
   "0", "0", "0", "0", "0", "0", "0", "0",
   "0", "0", "0", "0", "0", "0", "0", "0", 
   "1", "1", "1", "1", "1", "1", "0", "1", 
   "1", "1", "1", "1", "1", "1", "0", "1",
   "1", "1", "1", "1", "1", "1", "0", "1",
   "1", "1", "1", "1", "0", "0", "1", "1",
   "1", "1", "1", "1", "1", "1", "1", "1",
   "1", "1", "0", "1", "0", "1", "0", "1",
   "1", "1", "0", "0", "0", "0", "0", "1",
   "1", "1", "0", "0", "0", "0", "0", "0",
   "1", "0", "1", "1", "1", "1", "0", "1",
   "1", "0", "0", "1", "0", "1", "0", "1"
  ) |> 
  mutate(
    observed_y = case_when(
      A == "0" ~ Y_a0,
      A == "1" ~ Y_a1
    ),
    ITE = as.numeric(Y_a1) - as.numeric(Y_a0)
  ) |> 
  arrange(
    A, observed_y, X
  ) |> 
  select(X, A, M_a0, M_a1, Y_m0, Y_m1, Y_a0, Y_a1, ITE) |> 
  mutate(
    observed_m = case_when(
      A == "0" ~ M_a0,
      A == "1" ~ M_a1
    ),
    observed_y = case_when(
      A == "0" ~ Y_a0,
      A == "1" ~ Y_a1
    )
  ) |> 
  arrange(
    A, observed_y, X
  )

countefactual_data_reactable_raw <- countefactual_data |> 
  reactable(
    theme = reactableTheme(
      backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )
    ),
    sortable = FALSE,
    defaultPageSize = 19,
    columns = list(
      observed_y = colDef(
        show = FALSE
      ),
      observed_m = colDef(
        show = FALSE
      ),
      ITE = colDef(
        style = function(value) {
          if (value == "1")
            list(background = "pink")
        }
      ),
      Y_a0 = colDef(
        name = "Y<sup>A0",
        html = TRUE,
        style = function(value) {
          
        base_style <- list(
            boxShadow = "inset 0 0 0 3px #0B3D02"
          )
        
          if (value == "1"){
            base_style$background <- "pink"
          }
        
          base_style
        
        }
      ),
      M_a1 = colDef(
        name = "M<sup>A1",
        html = TRUE,
        style = function(value) {
          if (value == "1")
            list(background = "lightgray")
        }
      ),
      M_a0 = colDef(
        name = "M<sup>A0",
        html = TRUE,
        style = function(value) {
          base_style <- list(
            boxShadow = "inset 0 0 0 3px #0B3D02"
          )

          if (value == "1") {
            base_style$background <- "lightgray"
          }

          base_style
        }
      ),
      Y_a1 = colDef(
        name = "Y<sup>A1",
        html = TRUE,
        style = function(value) {
          if (value == "1")
            list(background = "pink")
        }
      ),
      Y_m0 = colDef(
        name = "Y<sup>M0",
        html = TRUE,
        style = function(value, index, name) {
          base_style <- list()

          # keep your original blue background logic
          if (value == "1") {
            base_style$background <- "#E6D7FF"
          }

          # add rectangle to Y_m0 when M_a0 == "0"
          if (!is.null(index) && countefactual_data$M_a0[index] == "0") {
            base_style$boxShadow <- "inset 0 0 0 3px #0B3D02"
          }

          base_style
        }
      ),
      Y_m1 = colDef(
        name = "Y<sup>M1",
        html = TRUE,
        style = function(value, index, name) {
          base_style <- list()

          # keep your original blue background logic
          if (value == "1") {
            base_style$background <- "#E6D7FF"
          }

          # add rectangle to Y_m1 when M_a0 == "1"
          if (!is.null(index) && countefactual_data$M_a0[index] == "1") {
            base_style$boxShadow <- "inset 0 0 0 3px #0B3D02"
          }

          base_style
        }
      )
    ),
    defaultColDef = colDef(maxWidth = 50),
    style = list(fontSize = "1rem")
  )

countefactual_data_reactable_raw

```

:::

::: {.column width="55%"}

#### üòá God-Given Counterfactual Data

We can now explore how the components of the Natural Indirect Effect:

$$Y|[do(M|do(A=0))] = Y|do(A=0)$$

![](nde.png)

:::


:::::

## {.smaller}

::::: columns
::: {.column width="45%"}

```{r}
countefactual_data <- tibble::tribble(
   ~"X", ~"A", ~"Y_a0", ~"Y_a1", ~"M_a0", ~"M_a1", ~"Y_m0", ~"Y_m1",
   "0", "1", "0", "1", "0", "1", "0", "1",
   "0", "1", "0", "0", "0", "0", "0", "0",
   "0", "0", "1", "1", "1", "1", "1", "1",
   "0", "0", "0", "1", "0", "1", "0", "1",
   "0", "0", "0", "0", "0", "0", "0", "0",
   "0", "0", "0", "0", "0", "0", "0", "0", 
   "1", "1", "1", "1", "1", "1", "0", "1", 
   "1", "1", "1", "1", "1", "1", "0", "1",
   "1", "1", "1", "1", "1", "1", "0", "1",
   "1", "1", "1", "1", "0", "0", "1", "1",
   "1", "1", "1", "1", "1", "1", "1", "1",
   "1", "1", "0", "1", "0", "1", "0", "1",
   "1", "1", "0", "0", "0", "0", "0", "1",
   "1", "1", "0", "0", "0", "0", "0", "0",
   "1", "0", "1", "1", "1", "1", "0", "1",
   "1", "0", "0", "1", "0", "1", "0", "1"
  ) |> 
  mutate(
    observed_y = case_when(
      A == "0" ~ Y_a0,
      A == "1" ~ Y_a1
    ),
    ITE = as.numeric(Y_a1) - as.numeric(Y_a0)
  ) |> 
  arrange(
    A, observed_y, X
  ) |> 
  select(X, A, M_a0, M_a1, Y_m0, Y_m1, Y_a0, Y_a1, ITE) |> 
  mutate(
    observed_m = case_when(
      A == "0" ~ M_a0,
      A == "1" ~ M_a1
    ),
    observed_y = case_when(
      A == "0" ~ Y_a0,
      A == "1" ~ Y_a1
    )
  ) |> 
  arrange(
    A, observed_y, X
  )

countefactual_data_reactable_raw <- countefactual_data |> 
  reactable(
    theme = reactableTheme(
      backgroundColor = "#F5F2EB",
      tableStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      headerStyle = list(
        backgroundColor = "#F5F2EB"
      ),
      cellStyle = list(
        backgroundColor = "#F5F2EB"
      )
    ),
    sortable = FALSE,
    defaultPageSize = 19,
    columns = list(
      observed_y = colDef(
        show = FALSE
      ),
      observed_m = colDef(
        show = FALSE
      ),
      ITE = colDef(
        style = function(value) {
          if (value == "1")
            list(background = "pink")
        }
      ),

      # Y_a0: back to simple pink highlight, no rectangle
      Y_a0 = colDef(
        name = "Y<sup>A0",
        html = TRUE,
        style = function(value) {
          if (value == "1")
            list(background = "pink")
        }
      ),

      # M_a1: now gets the rectangle (instead of M_a0)
      M_a1 = colDef(
        name = "M<sup>A1",
        html = TRUE,
        style = function(value) {
          base_style <- list(
            boxShadow = "inset 0 0 0 3px #0B3D02"
          )

          if (value == "1") {
            base_style$background <- "lightgray"
          }

          base_style
        }
      ),

      # M_a0: no rectangle now, just original lightgray for 1
      M_a0 = colDef(
        name = "M<sup>A0",
        html = TRUE,
        style = function(value) {
          if (value == "1")
            list(background = "lightgray")
        }
      ),

      # Y_a1: now boxed instead of Y_a0
      Y_a1 = colDef(
        name = "Y<sup>A1",
        html = TRUE,
        style = function(value) {
          base_style <- list(
            boxShadow = "inset 0 0 0 3px #0B3D02"
          )

          if (value == "1") {
            base_style$background <- "pink"
          }

          base_style
        }
      ),

      # Y_m0: rectangle if M_a1 == "0"
      Y_m0 = colDef(
        name = "Y<sup>M0",
        html = TRUE,
        style = function(value, index, name) {
          base_style <- list()

          # keep original blue highlight
          if (value == "1") {
            base_style$background <- "#E6D7FF"
          }

          # add rectangle to Y_m0 when M_a1 == "0"
          if (!is.null(index) && countefactual_data$M_a1[index] == "0") {
            base_style$boxShadow <- "inset 0 0 0 3px #0B3D02"
          }

          base_style
        }
      ),

      # Y_m1: rectangle if M_a1 == "1"
      Y_m1 = colDef(
        name = "Y<sup>M1",
        html = TRUE,
        style = function(value, index, name) {
          base_style <- list()

          # keep original blue highlight
          if (value == "1") {
            base_style$background <- "#E6D7FF"
          }

          # add rectangle to Y_m1 when M_a1 == "1"
          if (!is.null(index) && countefactual_data$M_a1[index] == "1") {
            base_style$boxShadow <- "inset 0 0 0 3px #0B3D02"
          }

          base_style
        }
      )
    ),
    defaultColDef = colDef(maxWidth = 50),
    style = list(fontSize = "1rem")
  )

countefactual_data_reactable_raw


```

:::

::: {.column width="55%"}

#### üòá God-Given Counterfactual Data

We can now explore how the components of the Natural Indirect Effect:

$$Y|[do(M|do(A=1))] = Y|do(A=1)$$

![](nie.png)
:::

:::::

## NIE under Pure Mediation {.smaller}

::::: columns
::: {.column width="30%"}
![](nde.png)

![](nie.png)
:::

::: {.column width="70%"}
$NIE = Y|do(A=1) - Y|do(A=0) = TE$

Finally, we see that the Natural Indirect Effect equals the Total Effect, because under pure mediation the entire effect of the treatment on the outcome is transmitted through the mediator.

:::
:::::


## Inspiration {.smaller}


{{< video https://youtu.be/e1a5Ftdd8Xw width="50%" height="42.5%" >}}


The images in this presentation are highly inspired by the wonderful French TV Series: "Il √©tait une fois‚Ä¶ la Vie".

Whenever I think about unintuitive mediators in healthcare, I remember how this educational animated series helped me understand complex concepts.

And also in [English](https://www.youtube.com/watch?v=sn3tBnb4Nck) and [Hebrew](https://www.youtube.com/watch?v=LrnYAMVUVjA)
